---
layout: post
title: type-checked null in java (or, how to make NPEs impossible)
---
<h1>{{ page.title }}</h1>


<style type="text/css"> 
p {
  margin-top: 0em;
  margin-bottom: 0em;
  margin:0px;
  font-family: helvetica, arial, sans-serif;
  font-size: 13px;
}
</style>
    <p style=''><span style="display:none;">
type-checked null in java (or, how to make NPEs impossible)</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
type-checked null means we can use type signatures to force the usercode to either a) explicitly use the Optional class, or b) provide a default value. compilermakes it impossible to forget that you need to consider null.&nbsp;</p><p style='margin-left:22px'>
&nbsp;</p><p style='margin-left:22px'><span style="color:rgb(153, 153, 136);font-style:italic;font-family:monospace;background-color:rgb(255, 255, 255);">
</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">public</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">static</span> Optional<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&lt;</span>Boolean<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&gt;</span> parseBool<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>String sbool<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">{</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
if</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>sbool == null || "".equals(null)<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">return</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> None<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&lt;</span>Boolean<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&gt;();</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
else</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">return</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> Some<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&lt;</span>Boolean<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&gt;(</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(221, 17, 68);">"true"</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">equals</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>sbool<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">));</span> </span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">}</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
public</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">static</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;color:rgb(68, 85, 136);">boolean</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;color:rgb(153, 0, 0);">parseBool</span>(</span>String sbool<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;color:rgb(68, 85, 136);">boolean</span> alternative<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">{</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
if</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>sbool == null || "".equals(null)<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">return</span> alternative<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">;</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
else</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">return</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(221, 17, 68);">"true"</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">equals</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>sbool<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span> </span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">}</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
The key is that <span style="font-family:courier new,monospace;">parseBool</span> is overloaded. one version takes just a string, but since the operation may fail, it returns <span style="font-family:monospace;">Optional</span>, which means you can't assign the result to <span style="font-family:monospace;">boolean</span> or <span style="font-family:monospace;">Boolean</span>. the other version takes <span style="font-family:monospace;">(String, boolean defaultValue)</span> which returns a <span style="font-family:monospace;">boolean</span>.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
Usage: suppose <span style="font-family:monospace;">getParameterValue </span>returns <span style="font-family:monospace;">String</span>, or <span style="font-family:monospace;">null </span>if the parameter wasn't on the request.&nbsp;</p><p style=''>
&nbsp;</p><p style='margin-left:22px'>
<span style="color:rgb(153, 153, 136);font-style:italic;background-color:rgb(255, 255, 255);font-family:monospace;">// guaranteed to be defined, fallback value supplied</span></span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
Boolean foobar <span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">=</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(0, 128, 128);">parseBool</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span>&nbsp;</p><p style='margin-left:44px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">
</span>request<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">.</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(0, 128, 128);">getParameterValue</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(221, 17, 68);">"foobar"</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">),</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">false);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">if</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span>foobar<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">)</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(153, 153, 136);font-style:italic;">// compiles</span></span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
</span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
<span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(153, 153, 136);font-style:italic;">// explicitly allowing undefined</span></span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
Optional<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">&lt;</span>Boolean<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">&gt;</span> foobar2 <span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">=</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(0, 128, 128);">parseBool</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span>&nbsp;</p><p style='margin-left:44px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">
</span>request<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">.</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(0, 128, 128);">getParameterValue</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(221, 17, 68);">"foobar2"</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">));</span></span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">if</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span>foobar2<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">)</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(153, 153, 136);font-style:italic;">// doesn't compile due to possible possible NPE</span></span>&nbsp;</p><p style='margin-left:22px'><span style="background-color:rgb(255, 255, 255);font-family:monospace;">
<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">if</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">(</span>foobar2<span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">.</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(0, 128, 128);">hasValue</span><span style="background-color:rgb(255, 255, 255);font-family:monospace;font-weight:bold;">())</span> <span style="background-color:rgb(255, 255, 255);font-family:monospace;color:rgb(153, 153, 136);font-style:italic;">// compiles, will never ever NPE</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
<a href="https://gist.github.com/1236562">full implementation for Optional, Some and None</a> on github, it's quite simple, you could probably figure it out in half an hour. this implementation is based on that described in an awesome, super short book <a href="http://www.amazon.com/Functional-Programming-Java-Developers-Concurrency/dp/1449311032">Functional Programming for Java Developers</a>, i read it in about an hour.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
A little history, from "Tony Hoare, Inventor of QuickSort, Turing Award Winner": &nbsp;</p><p style=''>
&nbsp;</p><p style='margin-left:22px'>
<span style="font-style:italic;">"I call it my billion-dollar mistake. It was the invention of the null reference in 1965. At that time, I was designing the first comprehensive type system for references in an object oriented language (ALGOL W). My goal was to ensure that all use of references should be absolutely safe, with checking performed automatically by the compiler. But I couldn't resist the temptation to put in a null reference, simply because it was so easy to implement. This has led to innumerable errors, vulnerabilities, and system crashes, which have probably caused a billion dollars of pain and damage in the last forty years. In recent years, a number of program analysers like PREfix and PREfast in Microsoft have been used to check references, and give warnings if there is a risk they may be non-null. More recent programming languages like Spec# have introduced declarations for non-null references. This is the solution, which I rejected in 1965." [3]</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
'Optional' is also part of C++ via boost [1][2]. C++ needs type-checked null less than Java because C++ references aren't nullable, but pointers are. we <a href="https://github.com/ac3522/awkward-squad">implemented this last night at my Haskell study group</a>. cool.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
[1] <a href="http://www.boost.org/doc/libs/1_47_0/libs/optional/doc/html/index.html">boost::optional overview and motivation&nbsp;</p><p style=''>
</a>[2] <a href="http://www.boost.org/doc/libs/1_46_1/boost/optional/optional.hpp">boost::optional source code, if you can make any sense of it, bulletproof C++ is hard&nbsp;</p><p style=''>
</a>[3] <a href="http://qconlondon.com/london-2009/presentation/Null+References:+The+Billion+Dollar+Mistake">http://qconlondon.com/london-2009/presentation/Null+References:+The+Billion+Dollar+Mistake</a>&nbsp;</p>