---
layout: post
title: extjs ajax implementation internals, and the evolution of XMLHttpRequest
---
<h1>{{ page.title }}</h1>


<style type="text/css"> 
p {
  margin-top: 0em;
  margin-bottom: 0em;
  margin:0px;
  font-family: helvetica, arial, sans-serif;
  font-size: 13px;
}
</style>
    <p style=''><span style="display:none;">
extjs ajax implementation internals, and the evolution of XMLHttpRequest</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
At work we changed the core ajax implementation to work around a problem for a client. It turned into an interesting lesson in the evolution of XMLHttpRequest.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
The official Ext-3.3.3 implementation remains but commented out. The original impl is as important as the new one. The full snippet is available here on github: <a href="https://gist.github.com/db1ee255ecc57e7b3e47">re-implement Ext Ajax to use XHR events instead of readyState polling&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
</a>TLDR: The official Ext-3.3.3 implementation maintains compat with IE6 and works around an unstable spec by polling readyState instead of using XHR's native events.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
Ext.lib.Ajax <span style="font-weight:bold;">=</span> <span style="font-weight:bold;">function</span> () {&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// *djg* snip... blah blah blah</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">function</span> handleReadyState(o, callback) {</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
callback <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> callback <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> {};</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">var</span> conn <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> o.conn, <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// *djg* this is the XMLHttpRequest object</span></span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
tId <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> o.tId,</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
poll <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> pub.poll,</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
cbTimeout <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> callback.timeout <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">null</span>;</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">if</span> (cbTimeout) {</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
pub.conn[tId] <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> conn;</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
pub.timeout[tId] <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> setTimeout(<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">function</span> () {</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
pub.abort(o, callback, <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}, cbTimeout);</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// issue-12345 re-implement Ext Ajax to use XHR events instead of readyState polling *wspt*</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// Implement ajax using XHR events instead of polling, as a possible workaround</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// to avoid clearInterval corruption during activex control operations</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// onreadystatechange introduced in IE7 &lt;<a href="http://msdn.microsoft.com/en-us/library/dd576252(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/dd576252(v=vs.85).aspx</a>&gt;</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">conn.onreadystatechange <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">function</span> () {</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-style:italic;color:rgb(153, 153, 136);">// never get here on abort, see pub.abort() below</span></span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">if</span> (conn.readyState <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">==</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);color:rgb(0, 153, 153);">4</span>) {</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">if</span> (cbTimeout) {</span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
clearTimeout(pub.timeout[tId]);</span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
pub.timeout[tId] <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">null</span>;</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
}</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
handleTransactionResponse(o, callback);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
}</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">
};</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">/*</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
poll[tId] = setInterval(</span></span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">function() {</span></span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">if (conn &amp;&amp; conn.readyState == 4) {</span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
clearInterval(poll[tId]);</span></span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">poll[tId] = null;</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
</span></span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">if (cbTimeout) {</span></span>&nbsp;</p><p style='margin-left:132px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">clearTimeout(pub.timeout[tId]);</span></span>&nbsp;</p><p style='margin-left:132px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">pub.timeout[tId] = null;</span></span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">}</span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
</span></span>&nbsp;</p><p style='margin-left:110px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">handleTransactionResponse(o, callback);</span></span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">}</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
},</span></span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">pub.pollInterval);</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
*/</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// end *wspt*</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">function</span> asyncRequest(method, uri, callback, postData) {</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">var</span> o <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> getConnectionObject() <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">null</span>;</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">if</span> (o) {</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
o.conn.open(method, uri, <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">if</span> (pub.useDefaultXhrHeader) {</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
initHeader(<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(221, 17, 68);">'X-Requested-With'</span>, pub.defaultXhrHeader);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">if</span> (postData <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">&amp;&amp;</span> pub.useDefaultHeader <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">&amp;&amp;</span> (<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">!</span>pub.headers <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">!</span>pub.headers[CONTENTTYPE])) {</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
initHeader(CONTENTTYPE, pub.defaultPostHeader);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">if</span> (pub.defaultHeaders <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> pub.headers) {</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
setHeader(o);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
handleReadyState(o, callback);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
o.conn.send(postData <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">null</span>);</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">return</span> o;</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">var</span> pub <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> { <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// *djg* this is the public API</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
request<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">function</span> (method, uri, cb, data, options) {</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// *djg* snip... blah blah blah</span></span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">return</span> asyncRequest(method <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> options.method <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">||</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(221, 17, 68);">"POST"</span>, uri, cb, data);</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
},</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
useDefaultHeader<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>,</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
defaultPostHeader<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(221, 17, 68);">'application/x-www-form-urlencoded; charset=UTF-8'</span>,</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
useDefaultXhrHeader<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>,</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
defaultXhrHeader<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(221, 17, 68);">'XMLHttpRequest'</span>,</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
poll<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> {},</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
timeout<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> {},</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
conn<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> {},</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
pollInterval<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(0, 153, 153);">50</span>,</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
transactionId<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(0, 153, 153);">0</span>,</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
abort<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">function</span> (o, callback, isTimeout) {</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">var</span> me <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">this</span>,</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
tId <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> o.tId,</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
isAbort <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">false</span>;</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">if</span> (me.isCallInProgress(o)) {</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">// issue-12345 re-implement Ext Ajax to use XHR events instead of readyState polling *wspt*</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// the XHR spec says, on xhr.abort (e.g. timeout expired), set readyState=4 then </span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// call onReadyStateChange, which makes aborts very difficult to detect here. </span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// See discussion towards end of &lt;<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=379824">https://bugzilla.mozilla.org/show_bug.cgi?id=379824</a>&gt;</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// To work around this in browser-compat way, we set conn.onreadystatechange = null right before we </span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// abort, see pub.abort() below. This is the way Ext 4 does it &lt;<a href="http://docs.sencha.com/ext-js/4-0/source/Connection.html">http://docs.sencha.com/ext-js/4-0/source/Connection.html</a>&gt;</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
</span><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);">o.conn.onreadystatechange <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;background-color:rgb(255, 229, 0);font-weight:bold;">null</span>;</span></span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
o.conn.abort();</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;background-color:rgb(255, 229, 0);">//clearInterval(me.poll[tId]);</span></span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;background-color:rgb(255, 229, 0);">//me.poll[tId] = null;</span></span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
// end *wspt*</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(153, 153, 136);font-style:italic;">
</span>clearTimeout(pub.timeout[tId]);</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
me.timeout[tId] <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">null</span>;</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
handleTransactionResponse(o, callback, (isAbort <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">=</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>), isTimeout);</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">return</span> isAbort;</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
},</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
isCallInProgress<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">function</span> (o) {</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">return</span> o.conn <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">&amp;&amp;</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">!</span>{</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(0, 153, 153);">0</span><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>,</span>&nbsp;</p><p style='margin-left:88px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;color:rgb(0, 153, 153);">4</span><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">:</span> <span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">true</span>&nbsp;</p><p style='margin-left:66px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">
</span>}[o.conn.readyState];</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
}</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
};</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
<span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;font-weight:bold;">return</span> pub;</span>&nbsp;</p><p style=''><span style="font-family:'Bitstream Vera Sans Mono', 'Courier New', monospace;">
</span>}();&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
here's the most interesting discussion on the mozilla bugtracker[1]:&nbsp;</p><p style='margin-left:22px'>
&nbsp;</p><p style='margin-left:22px'>
Comment 24 bugzilla33 2008-02-21 05:32:38 PST&nbsp;</p><p style='margin-left:22px'>
@lunter: Could you attach a minimal testcase showing the behaviour you think is&nbsp;</p><p style='margin-left:22px'>
wrong and describe what you think the right behaviour should be.&nbsp;</p><p style='margin-left:22px'>
Yes, I can.&nbsp;</p><p style='margin-left:22px'>
<a href="https://bugzilla.mozilla.org/attachment.cgi?id=300331">https://bugzilla.mozilla.org/attachment.cgi?id=300331</a>&nbsp;</p><p style='margin-left:22px'>
WC3 says that:&nbsp;</p><p style='margin-left:22px'>
<a href="http://www.w3.org/TR/XMLHttpRequest/#abort">http://www.w3.org/TR/XMLHttpRequest/#abort</a>&nbsp;</p><p style='margin-left:22px'>
"4. Switch the state to UNSENT. (Do not dispatch the readystatechange event.)"&nbsp;</p><p style='margin-left:22px'>
Now gecko calls readystatechange event on abort(). (Opera and Safari do not dispatch).&nbsp;</p><p style='margin-left:22px'>
IMHO abort() must switch the state to UNSENT (readyState = 0) without&nbsp;</p><p style='margin-left:22px'>
dispatching the readystatechange event.&nbsp;</p><p style='margin-left:22px'>
&nbsp;</p><p style='margin-left:22px'>
SomeGuy 2008-02-21 05:02:29 PST&nbsp;</p><p style='margin-left:22px'>
When the bug was launched the w3c said to not dispatch the readystate event and set state straight to 0. That functionality being the opposite of what gecko did.&nbsp;</p><p style='margin-left:22px'>
The working draft however _now_ states to do exactly what gecko does.&nbsp;</p><p style='margin-left:22px'>
Now ironically opera and others are incorrect in their implementation.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
Note the confusion in the spec: the original spec had sensible behavior, but they later changed the spec to be in line with the most common implementation.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
[1] <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=379824">https://bugzilla.mozilla.org/show_bug.cgi?id=379824</a>&nbsp;</p><p style=''>
</a>[2] <a href="http://en.wikipedia.org/wiki/XMLHttpRequest#The_onreadystatechange_event_listener">http://en.wikipedia.org/wiki/XMLHttpRequest#The_onreadystatechange_event_listener</a>&nbsp;</p>