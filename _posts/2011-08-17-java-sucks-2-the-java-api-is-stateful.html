---
layout: post
title: java sucks #2: the java API is stateful
---
<h1>{{ page.title }}</h1>


<style type="text/css"> 
p {
  margin-top: 0em;
  margin-bottom: 0em;
  margin:0px;
  font-family: helvetica, arial, sans-serif;
  font-size: 13px;
}
</style>
    <p style=''><span style="display:none;">
java sucks #2: the java API is stateful</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
two snippets: the first one i wrote ("to fix the bug"), and the second one i wrote because I'm disciplined and tight code makes me happy.&nbsp;</p><p style=''>
&nbsp;</p><p style='margin-left:22px'>
<span style="color:rgb(153, 153, 136);font-style:italic;font-family:monospace;background-color:rgb(255, 255, 255);">// issue-12345 Advanced Search - Date "=" operator must truncate datetime fields</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-style:italic;color:rgb(153, 153, 136);">// we could also fix this in LiteralCompareCondition, but we don't want to cause system-wide changes right now.</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-style:italic;color:rgb(153, 153, 136);">// TODO: add orm field type to distinguish between sql TIMESTAMP and DATE.</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-style:italic;color:rgb(153, 153, 136);">// first pass "to fix the bug"</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
Calendar cal <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">getInstance</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">();</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">setTime</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">((</span>java<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">util</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">Date</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> value<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">set</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">HOUR_OF_DAY</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 153, 153);">0</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">set</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">MINUTE</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 153, 153);">0</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">set</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">SECOND</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 153, 153);">0</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">set</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">MILLISECOND</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 153, 153);">0</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
Date timeLowerBound <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">getTime</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">();</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">add</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">DATE</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 153, 153);">1</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
Date timeUpperBound <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> cal<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">getTime</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">();</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
List<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&lt;</span>ICondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&gt;</span> timerange <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> Arrays<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">asList</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>ICondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-style:italic;color:rgb(153, 153, 136);">// lol java needs this cast gotta be an eclipse bug</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;color:rgb(153, 0, 0);">LiteralCompareCondition</span>(</span>fieldName<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> CompareCondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">GREATER_THAN_EQUAL</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> timeLowerBound<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">false),</span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
new</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(153, 0, 0);font-weight:bold;">LiteralCompareCondition</span>(</span>fieldName<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> CompareCondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">LESS_THAN</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> timeUpperBound<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">false)</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">return</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;color:rgb(153, 0, 0);">CompositeCondition</span>(</span>CompositeCondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">AND</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> timerange<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
</span>&nbsp;</p><p style=''><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">
</span>The second attempt required I write some <a href="https://gist.github.com/1152085">DateUtils infrastructure</a></span>&nbsp;</p><p style=''><span style="background-color:rgb(255, 255, 255);">
</span>&nbsp;</p><p style='margin-left:22px'><span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">
</span><span style="color:rgb(153, 153, 136);font-family:monospace;font-style:italic;background-color:rgb(255, 255, 255);">// refactored code</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">
</span>java<span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">.</span><span style="color:rgb(0, 128, 128);font-family:monospace;background-color:rgb(255, 255, 255);">util</span><span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">.</span><span style="color:rgb(0, 128, 128);font-family:monospace;background-color:rgb(255, 255, 255);">Date</span> datetime <span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">=</span> <span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">(</span>java<span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">.</span><span style="color:rgb(0, 128, 128);font-family:monospace;background-color:rgb(255, 255, 255);">util</span><span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">.</span><span style="color:rgb(0, 128, 128);font-family:monospace;background-color:rgb(255, 255, 255);">Date</span><span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">)</span> value<span style="font-weight:bold;font-family:monospace;background-color:rgb(255, 255, 255);">;</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
Date dateFloor <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> DateUtils<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">trimToJustDate</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>datetime<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
Date dateCeil <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> DateUtils<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">trimToJustDate</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>DateUtils<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">add</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>datetime<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> Calendar<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">DATE</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 153, 153);">1</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">));</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
List<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&lt;</span>ICondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">&gt;</span> timerange <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">=</span> Arrays<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">asList</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">(</span>ICondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">)</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-style:italic;color:rgb(153, 153, 136);">// lol java needs this cast gotta be an eclipse bug</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(153, 0, 0);font-weight:bold;">LiteralCompareCondition</span>(</span>fieldName<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> CompareCondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">GREATER_THAN_EQUAL</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> dateFloor<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">false),</span></span>&nbsp;</p><p style='margin-left:44px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(153, 0, 0);font-weight:bold;">LiteralCompareCondition</span>(</span>fieldName<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> CompareCondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">LESS_THAN</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> dateCeil<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">false)</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style='margin-left:22px'><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">return</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">new</span> <span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(153, 0, 0);font-weight:bold;">CompositeCondition</span>(</span>CompositeCondition<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">.</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);color:rgb(0, 128, 128);">AND</span><span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">,</span> timerange<span style="font-family:monospace;background-color:rgb(255, 255, 255);font-weight:bold;">);</span></span>&nbsp;</p><p style=''><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
</span>&nbsp;</p><p style=''><span style="font-family:monospace;background-color:rgb(255, 255, 255);">
</span>Look at the difference in readability by using a non-stateful api!&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
At the cost of adding 30 lines? I lean towards strongly valuing tight code even at the most tactical level, but this is such a trivial case that many people would call this a push. But when we compose bigger modules out of these small pieces, i speculate we'd find it really hard to build a stateless module from stateful building blocks.&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
<span style="font-weight:bold;">Java sucks because a stateful API forces coders towards stateful modules</span>&nbsp;</p><p style=''>
&nbsp;</p><p style=''>
Obviously it's not practical to wrap java's apis into non-stateful versions everywhere, nor performant to constantly invoke convenience factories to clean up Java's date/calendar/timestamp mess. Unfortunately, over-abstractions and stateful APIs are pervasive in Java's API, though.&nbsp;</p>